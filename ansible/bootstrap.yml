---
- hosts: all
  vars:
    provision_repo: "https://github.com/usernamenumber/provision/"
    provision_dir: "/usr/local/tunapanda/provision"
    provision_ver: "bootstrap"
    edx_repo: "https://github.com/tunapanda/configuration/"
    edx_dir: "/usr/local/tunapanda/edx"
    edx_ver: "master"
  tasks:
  - name: "install dependencies"
    apt: 
      name="{{ item }}"
      state=installed
    with_items:
      - git

    # Cheap way to ensure that github's host key is known. Otherwise ansible may stall if it tries to
    # update a repo with an ssh url
  - name: Store github host key
    command: ssh -o StrictHostKeyChecking=no git@github.com 'true'
    ignore_errors: yes

  - name: "provisioning repo"
    git: 
      repo="{{ provision_repo }}"
      dest="{{ provision_dir }}"
      version="{{ provision_ver }}"
      update=yes
      recursive=yes

  - name: "edx repo"
    git:
      repo="{{ edx_repo }}"
      dest="{{ edx_dir }}"
      version="{{ edx_ver }}"
      update=yes
      recursive=yes

  - name: "provision at boot"
    lineinfile:
      dest="/etc/rc.local"
      state="present"
      regexp="{{ provision_dir }}"
      line="[ -x '{{ provision_dir }}/scripts/bootstrap.sh' ] && {{ provision_dir }}/scripts/bootstrap.sh"

